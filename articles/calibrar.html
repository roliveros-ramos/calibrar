<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Getting started with the `calibrar` package • calibrar</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../katex-auto.js"></script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><link href="../deps/KaTex-0.16.10/katex.min.css" rel="stylesheet">
<script src="../deps/KaTex-0.16.10/katex.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Getting started with the `calibrar` package">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">calibrar</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.0.9008</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/calibrar.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/v02-parameter_estimation.html">Using the `calibrate()` function for parameter estimation</a></li>
    <li><a class="dropdown-item" href="../articles/v03-parameter_estimation_ODE.html">Parameter estimation for ODE systems</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/roliveros-ramos/calibrar/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Getting started with the `calibrar` package</h1>
                        <h4 data-toc-skip class="author">Ricardo
Oliveros-Ramos</h4>
            
            <h4 data-toc-skip class="date">2025-04-08</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/roliveros-ramos/calibrar/blob/master/vignettes/calibrar.Rmd" class="external-link"><code>vignettes/calibrar.Rmd</code></a></small>
      <div class="d-none name"><code>calibrar.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This package allows the parameter estimation (i.e. calibration) of
complex models, including stochastic ones. It implements generic
functions that can be used for fitting any type of models, especially
those with non-differentiable objective functions, with the same syntax
as <code>base::optim</code>. It supports multiple phases estimation
(sequential parameter masking), constrained optimization (bounding box
restrictions) and automatic parallel computation of numerical gradients.
Some common maximum likelihood estimation methods and automated
construction of the objective function from simulated model outputs is
provided.</p>
</div>
<div class="section level2">
<h2 id="basic-usage">Basic usage<a class="anchor" aria-label="anchor" href="#basic-usage"></a>
</h2>
<p>This vignette covers the basic usage of the package, introducing the
functions <code><a href="../reference/optim2.html">optim2()</a></code>, <code><a href="../reference/optimh.html">optimh()</a></code> and
<code><a href="../reference/calibrate.html">calibrate()</a></code>.</p>
<div class="section level3">
<h3 id="optim2">optim2()<a class="anchor" aria-label="anchor" href="#optim2"></a>
</h3>
<p>As the name sugests, <code><a href="../reference/optim2.html">optim2()</a></code> is intended to extend the
functionality of <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">stats::optim()</a></code> and it uses the same
arguments (with some additions):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optim2.html">optim2</a></span><span class="op">(</span></span>
<span>  <span class="va">par</span>,</span>
<span>  <span class="va">fn</span>,</span>
<span>  gr <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Nelder-Mead"</span>, <span class="st">"BFGS"</span>, <span class="st">"CG"</span>, <span class="st">"L-BFGS-B"</span>, <span class="st">"SANN"</span>, <span class="st">"Brent"</span>, <span class="st">"nlm"</span>, <span class="st">"nlminb"</span>,</span>
<span>    <span class="st">"Rcgmin"</span>, <span class="st">"Rvmmin"</span>, <span class="st">"hjn"</span>, <span class="st">"spg"</span>, <span class="st">"LBFGSB3"</span>, <span class="st">"AHR-ES"</span><span class="op">)</span>,</span>
<span>  lower <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>,</span>
<span>  upper <span class="op">=</span> <span class="op">+</span><span class="cn">Inf</span>,</span>
<span>  active <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  hessian <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The first difference is the possible values for the
<code>method</code> argument. In addition to the first six methods, also
available in <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code>, <code><a href="../reference/optim2.html">optim2()</a></code> gives access to
<code><a href="https://rdrr.io/r/stats/nlm.html" class="external-link">stats::nlm()</a></code> and <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">stats::nlminb()</a></code> but with the
same syntax as <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code> to make them easy to use. In
addition, three methods from the <code>optimr</code> package
(<code>Rcgmin</code>, <code>Rvmmin</code>, <code>hjn</code>), the
L-BFGS-B v3 implemented in the <code>bfgsb3c</code> package and the
<code>AHR-ES</code> (Adaptative Hierarchical Recombination Evolutionary
Strategy) implemented in this package.</p>
<p>In the next example, we compare the outputs of <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code>
and <code><a href="../reference/optim2.html">optim2()</a></code>:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://roliveros-ramos.github.io/calibrar/">calibrar</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] -1.931714e-04 -3.044063e-04 -1.744066e-04  1.940552e-05  5.641574e-05</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 1.639553e-07</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      456       NA </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optim2.html">optim2</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] -1.931714e-04 -3.044063e-04 -1.744066e-04  1.940552e-05  5.641574e-05</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 1.639553e-07</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      456       NA </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>The results are identical, as here <code><a href="../reference/optim2.html">optim2()</a></code> acts just as
a wrapper for <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code>. Now, we can run the same example
with two other methods:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optim2.html">optim2</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, method<span class="op">=</span><span class="st">"nlm"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] -2.500222e-13 -2.500222e-13 -2.500222e-13 -2.500222e-13 -2.500222e-13</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 3.125556e-25</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       NA       NA </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "Relative gradient is close to zero, current iterate is probably solution."</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">880820</span><span class="op">)</span> <span class="co"># for reproducibility</span></span>
<span><span class="fu"><a href="../reference/optim2.html">optim2</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, method<span class="op">=</span><span class="st">"AHR-ES"</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1]  3.749723e-10 -2.023475e-10  1.655858e-10 -2.272363e-10  1.488461e-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 2.827589e-19</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;     1024        0 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] "Stopping criteria reached in 128 generations."</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $generations</span></span>
<span><span class="co">#&gt; [1] 128</span></span></code></pre></div>
<p>The second difference is the new argument <code>active</code>, which
is a vector indicating if a parameters will be optimized (i.e. active)
or fixed to a constant value during the optimization process. In the
next example, we will fix the third and fourth parameters to its initial
values:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optim2.html">optim2</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, </span>
<span>       active<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">TRUE</span>, <span class="cn">TRUE</span>, <span class="cn">FALSE</span>, <span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning in paropt[isActive] &lt;- output$par: number of items to replace is not a</span></span>
<span><span class="co">#&gt; multiple of replacement length</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] 1.062264e-05 1.167696e-04 1.000000e+00 1.000000e+00 5.492100e-05</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      202       NA </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>As we can see, in the final solution, the <code>par</code> value keep
the values at 1, the initial value provided. All the numerical gradients
computed internally have also ‘masked’ this parameters and the
derivatives are not computed for them to speed up computation time.</p>
<p>Finally, the third difference is the new argument
<code>parallel</code>, that active the parallel computation of the
numerical gradient, when <code>gr</code> is not supplied:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optim2.html">optim2</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, parallel<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] -1.931714e-04 -3.044063e-04 -1.744066e-04  1.940552e-05  5.641574e-05</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 1.639553e-07</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;      456       NA </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<p>This last option will increase performance when the computation time
of <code>fn</code> in considerable. We will explain in detail this
feature in a following section.</p>
<p>Additionally, the method for the computation of the numerical
gradient can be chosen within the <code>control</code> list:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optim2.html">optim2</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">x</span><span class="op">^</span><span class="op">(</span><span class="fl">3.1</span><span class="op">*</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>gr.method<span class="op">=</span><span class="st">"richardson"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/optim2.html">optim2</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">x</span><span class="op">^</span><span class="op">(</span><span class="fl">3.1</span><span class="op">*</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>gr.method<span class="op">=</span><span class="st">"central"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/optim2.html">optim2</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="va">x</span><span class="op">^</span><span class="op">(</span><span class="fl">3.1</span><span class="op">*</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>gr.method<span class="op">=</span><span class="st">"forward"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="optimh">optimh()<a class="anchor" aria-label="anchor" href="#optimh"></a>
</h3>
<p>The function <code><a href="../reference/optimh.html">optimh()</a></code> has a similar functionality as
<code><a href="../reference/optim2.html">optim2()</a></code> but acts as a wrapper for several heuristic
optimization algorithms implemented in several packages:
<code>dfoptim</code>, <code>optimr</code>, <code>minqa</code>,
<code>cmaes</code>, <code>genSA</code>, <code>DEoptim</code>,
<code>soma</code>, <code>rgenoud</code> and <code>psoptim</code>. The
<code><a href="../reference/optimh.html">optimh()</a></code> function standardizes the inputs and outputs to
those of <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim()</a></code>, providing a more convenient user
interface. All specific arguments of this methods can be passed to the
original function using the <code>control</code> argument.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/optimh.html">optimh</a></span><span class="op">(</span></span>
<span>  <span class="va">par</span>,</span>
<span>  <span class="va">fn</span>,</span>
<span>  gr <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AHR-ES"</span>, <span class="st">"Nelder-Mead"</span>, <span class="st">"SANN"</span>, <span class="st">"hjn"</span>, <span class="st">"CMA-ES"</span>, <span class="st">"genSA"</span>, <span class="st">"DE"</span>, <span class="st">"soma"</span>,</span>
<span>    <span class="st">"genoud"</span>, <span class="st">"PSO"</span>, <span class="st">"hybridPSO"</span>, <span class="st">"mads"</span>, <span class="st">"hjk"</span>, <span class="st">"hjkb"</span>, <span class="st">"nmk"</span>, <span class="st">"nmkb"</span><span class="op">)</span>,</span>
<span>  lower <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>,</span>
<span>  upper <span class="op">=</span> <span class="op">+</span><span class="cn">Inf</span>,</span>
<span>  active <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  hessian <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Covariance Matrix Adaptation Evolutionary Strategy</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">880820</span><span class="op">)</span> <span class="co"># for reproducibility</span></span>
<span><span class="fu"><a href="../reference/optimh.html">optimh</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, method<span class="op">=</span><span class="st">"CMA-ES"</span>,</span>
<span>       control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit<span class="op">=</span><span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] -2.601340e-10 -4.546773e-10  4.311060e-10  4.155006e-11  2.101339e-10</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 5.061362e-19</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;     1600       NA </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 1</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; NULL</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Generalized Simulated Anneling</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">880820</span><span class="op">)</span> <span class="co"># for reproducibility</span></span>
<span><span class="fu"><a href="../reference/optimh.html">optimh</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, method<span class="op">=</span><span class="st">"genSA"</span>, </span>
<span>       lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>, upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>       control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit<span class="op">=</span><span class="fl">200</span>, temperature<span class="op">=</span><span class="fl">6000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1] 6.988898e-11 6.988898e-11 6.988898e-11 6.988898e-11 6.988898e-11</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 2.442235e-20</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;     2024        0 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] NA</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Self-Organising Migrating Algorithm</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">880820</span><span class="op">)</span> <span class="co"># for reproducibility</span></span>
<span><span class="fu"><a href="../reference/optimh.html">optimh</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, method<span class="op">=</span><span class="st">"soma"</span>,</span>
<span>       lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>, upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>       control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit<span class="op">=</span><span class="fl">200</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; $par</span></span>
<span><span class="co">#&gt; [1]  1.519459e-16 -4.704646e-16  8.741813e-17  1.169846e-17 -1.104563e-16</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $value</span></span>
<span><span class="co">#&gt; [1] 2.644038e-31</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $counts</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;     2000       NA </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $convergence</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $message</span></span>
<span><span class="co">#&gt; [1] NA</span></span></code></pre></div>
<p>The <code>maxit</code> control argument has been standardized to work
with all methods and to represent the maximum number of iterations of
the algorithm. However, the specific number of function evaluations per
iteration may vary between methods. You can refer to the help pages from
each package to have details about every specific method and its control
arguments.</p>
</div>
<div class="section level3">
<h3 id="running-in-parallel">Running in parallel<a class="anchor" aria-label="anchor" href="#running-in-parallel"></a>
</h3>
<p>Most algorithms implemented in <code><a href="../reference/optim2.html">optim2()</a></code> and some in
<code>optimh</code> can benefit of parallel computation. For the methods
that uses the numerical computation of the gradient, this will be
calculated in parallel. In order to support any type of parallel
implementation, the parallel setup is NOT automatic, and must be done by
the user previous to executed the optimization, as described in the
following example:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">ncores</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span> <span class="co"># number of cores to be used</span></span>
<span><span class="va">cl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">ncores</span><span class="op">)</span></span>
<span><span class="co"># this is slower than sequential for very fast models (like this one)</span></span>
<span><span class="fu"><a href="../reference/optim2.html">optim2</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>, </span>
<span>               control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>ncores<span class="op">=</span><span class="va">ncores</span><span class="op">)</span>, parallel<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span> <span class="co"># close the parallel connections</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="sequential-parameter-estimation">Sequential parameter estimation<a class="anchor" aria-label="anchor" href="#sequential-parameter-estimation"></a>
</h2>
<div class="section level3">
<h3 id="calibrate">calibrate()<a class="anchor" aria-label="anchor" href="#calibrate"></a>
</h3>
<p>The <code><a href="../reference/calibrate.html">calibrate()</a></code> function implements an automatic
sequential parameter estimation, meaning parameters can be un-masked
(set active) progressively during sequential phases of the calibration
process.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calibrate.html">calibrate</a></span><span class="op">(</span></span>
<span>  <span class="va">par</span>,</span>
<span>  <span class="va">fn</span>,</span>
<span>  gr <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  method <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  lower <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  upper <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  phases <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  hessian <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  replicates <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  parallel <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>With the basic syntax, the <code><a href="../reference/calibrate.html">calibrate()</a></code> function will
work similarly to <code><a href="../reference/optim2.html">optim2()</a></code> and <code><a href="../reference/optimh.html">optimh()</a></code>,
performing a simple optimization:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calibrate.html">calibrate</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="cn">NA</span>,<span class="cn">NA</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Using optimization method 'Rvmmin'.</span></span>
<span><span class="co">#&gt; Elapsed time: 0.00s</span></span>
<span><span class="co">#&gt; Function value: 1.24979e-16</span></span>
<span><span class="co">#&gt; Parameter values: -5e-09 -5e-09 -5e-09 -5e-09 -5e-09</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status: Rvmminu appears to have converged</span></span>
<span><span class="co">#&gt; Optimization using 'Rvmmin' algorithm.</span></span>
<span><span class="co">#&gt; Function value: 1.249787e-16 </span></span>
<span><span class="co">#&gt; Status: Rvmminu appears to have converged </span></span>
<span><span class="co">#&gt; Parameters:</span></span>
<span><span class="co">#&gt; [1] -4.999645e-09 -4.999291e-09 -4.998935e-09 -5.000000e-09 -5.000000e-09</span></span>
<span><span class="co">#&gt; Computation:</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       10        6</span></span></code></pre></div>
<p>If <code>upper</code> and <code>lower</code> bounds are provided, the
calibrate function can take <code>NA</code> as starting values for the
optimization, to some or all of the parameters:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calibrate.html">calibrate</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="cn">NA</span>,<span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>          lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>, upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Using optimization method 'Rvmmin'.</span></span>
<span><span class="co">#&gt; Elapsed time: 0.00s</span></span>
<span><span class="co">#&gt; Function value: 1.23526e-16</span></span>
<span><span class="co">#&gt; Parameter values: -4.98e-09 -4.97e-09 -4.96e-09 -5e-09 -4.94e-09</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status: Rvmminb appears to have converged</span></span>
<span><span class="co">#&gt; Optimization using 'Rvmmin' algorithm.</span></span>
<span><span class="co">#&gt; Function value: 1.235263e-16 </span></span>
<span><span class="co">#&gt; Status: Rvmminb appears to have converged </span></span>
<span><span class="co">#&gt; Parameters:</span></span>
<span><span class="co">#&gt; [1] -4.982589e-09 -4.974351e-09 -4.960025e-09 -4.999959e-09 -4.935026e-09</span></span>
<span><span class="co">#&gt; Computation:</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       13        5</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="setting-up-a-parameter-estimation-with-multiple-phases-">Setting up a parameter estimation with multiple phases.<a class="anchor" aria-label="anchor" href="#setting-up-a-parameter-estimation-with-multiple-phases-"></a>
</h3>
<p>Multiple <code>phases</code> can be set up by selecting a different
one for each parameter. The starting value of the optimization for each
phase is updated with the best parameters found in the previous
phase:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calibrate.html">calibrate</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="cn">NA</span>,<span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>          lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>, upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>          phases<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Parameter estimation in three phases.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 1: 2 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'Rvmmin'.</span></span>
<span><span class="co">#&gt;  Phase 1 finished (0.00s)</span></span>
<span><span class="co">#&gt;  Function value: 13</span></span>
<span><span class="co">#&gt;  Parameter values: -2.97e-08 -2.61e-08</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 2: 4 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'Rvmmin'.</span></span>
<span><span class="co">#&gt;  Phase 2 finished (0.00s)</span></span>
<span><span class="co">#&gt;  Function value: 9</span></span>
<span><span class="co">#&gt;  Parameter values: 5.84e-09 -3.93e-08 0 9.41e-09</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 3: 5 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'Rvmmin'.</span></span>
<span><span class="co">#&gt;  Phase 3 finished (0.00s)</span></span>
<span><span class="co">#&gt;  Function value: 1.24997e-16</span></span>
<span><span class="co">#&gt;  Parameter values: -5e-09 -5e-09 -5e-09 -5e-09 -5e-09</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status: Rvmminb appears to have converged</span></span>
<span><span class="co">#&gt; Optimization using 'Rvmmin' algorithm.</span></span>
<span><span class="co">#&gt; Function value: 1.24997e-16 </span></span>
<span><span class="co">#&gt; Status: Rvmminb appears to have converged </span></span>
<span><span class="co">#&gt; Parameters:</span></span>
<span><span class="co">#&gt; [1] -5.000004e-09 -5.000078e-09 -4.999605e-09 -5.000002e-09 -5.000006e-09</span></span>
<span><span class="co">#&gt; Computation:</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;       11        6</span></span></code></pre></div>
<p>When a phase is set to a negative number, the parameter is fixed at
its initial value during all the calibration and it is never
optimized:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calibrate.html">calibrate</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="cn">NA</span>,<span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">x</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>          lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>, upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>          phases<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="op">-</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Parameter estimation in two phases.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 1: 2 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'Rvmmin'.</span></span>
<span><span class="co">#&gt;  Phase 1 finished (0.00s)</span></span>
<span><span class="co">#&gt;  Function value: 13</span></span>
<span><span class="co">#&gt;  Parameter values: -2.97e-08 -2.61e-08</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 2: 4 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'Rvmmin'.</span></span>
<span><span class="co">#&gt;  Phase 2 finished (0.00s)</span></span>
<span><span class="co">#&gt;  Function value: 9</span></span>
<span><span class="co">#&gt;  Parameter values: 5.84e-09 -3.93e-08 0 9.41e-09</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status: Rvmminb appears to have converged</span></span>
<span><span class="co">#&gt; Optimization using 'Rvmmin' algorithm.</span></span>
<span><span class="co">#&gt; Function value: 9 </span></span>
<span><span class="co">#&gt; Status: Rvmminb appears to have converged </span></span>
<span><span class="co">#&gt; Parameters:</span></span>
<span><span class="co">#&gt; [1]  5.835174e-09 -3.934291e-08  3.000000e+00  0.000000e+00  9.410321e-09</span></span>
<span><span class="co">#&gt; * Some parameters are not calibrated.</span></span>
<span><span class="co">#&gt; Computation:</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;        6        4</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="dealing-with-stochastic-functions">Dealing with stochastic functions<a class="anchor" aria-label="anchor" href="#dealing-with-stochastic-functions"></a>
</h3>
<p>When dealing with stochastic functions, the argument
<code>replicates</code> can be helpful, as it allows to evaluate the
objective function several times, taking the average value of them as
the actual function value (as an approximation of the expected value of
the function). When <code>replicates=1</code>, the algorithm used by
default is “LBFGSB3”, but when replicates is greater than 1, “AHR-ES” is
used. The next examples use the function <code><a href="../reference/SphereN.html">sphereN()</a></code>, which
computes the Euclidean distance from a point <code>x</code> to the
origin of coordinates after a random displacement of its position (see
<code><a href="../reference/SphereN.html">?sphereN</a></code> for details). We will set the maximum number of
iterations to 1000 to speed up the execution of the vignette.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calibrate.html">calibrate</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="cn">NA</span>,<span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="va">sphereN</span>,</span>
<span>          lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>, upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>          phases<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>, replicates<span class="op">=</span><span class="fl">3</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit<span class="op">=</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Parameter estimation in three phases.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 1: 2 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'AHR-ES'.</span></span>
<span><span class="co">#&gt;  Phase 1 finished (1.08s)</span></span>
<span><span class="co">#&gt;  Function value: 12.9126</span></span>
<span><span class="co">#&gt;  Parameter values: -0.324 0.12</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 2: 4 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'AHR-ES'.</span></span>
<span><span class="co">#&gt;  Phase 2 finished (1.21s)</span></span>
<span><span class="co">#&gt;  Function value: 10.1169</span></span>
<span><span class="co">#&gt;  Parameter values: 0.0695 0.112 0.151 -0.0849</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 3: 5 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'AHR-ES'.</span></span>
<span><span class="co">#&gt;  Phase 3 finished (1.20s)</span></span>
<span><span class="co">#&gt;  Function value: 0.0534613</span></span>
<span><span class="co">#&gt;  Parameter values: -0.00843 0.0767 0.0606 0.0265 0.0048</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status: Maximum number of generations or function evaluations reached.</span></span>
<span><span class="co">#&gt; Optimization using 'AHR-ES' algorithm.</span></span>
<span><span class="co">#&gt; Function value: 0.05346132 </span></span>
<span><span class="co">#&gt; Status: Maximum number of generations or function evaluations reached. </span></span>
<span><span class="co">#&gt; Parameters:</span></span>
<span><span class="co">#&gt; [1] -0.008425148  0.076711662  0.060580990  0.026532747  0.004796660</span></span>
<span><span class="co">#&gt; Computation: (1000 generations)</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;     8000        0</span></span></code></pre></div>
<p>The number of replicates can be one single value or a vector with the
length equal to the number of phases:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calibrate.html">calibrate</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="cn">NA</span>,<span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="va">sphereN</span>,</span>
<span>          lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>, upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>          phases<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>, replicates<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit<span class="op">=</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Parameter estimation in three phases.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 1: 2 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'AHR-ES'.</span></span>
<span><span class="co">#&gt;  Phase 1 finished (0.90s)</span></span>
<span><span class="co">#&gt;  Function value: 13.3163</span></span>
<span><span class="co">#&gt;  Parameter values: -0.346 -0.101</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 2: 4 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'AHR-ES'.</span></span>
<span><span class="co">#&gt;  Phase 2 finished (0.97s)</span></span>
<span><span class="co">#&gt;  Function value: 9.8584</span></span>
<span><span class="co">#&gt;  Parameter values: 0.217 -0.335 0.24 0.101</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 3: 5 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'AHR-ES'.</span></span>
<span><span class="co">#&gt;  Phase 3 finished (1.42s)</span></span>
<span><span class="co">#&gt;  Function value: 0.0412229</span></span>
<span><span class="co">#&gt;  Parameter values: 0.0282 0.00574 -0.0127 -0.0375 -0.0192</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status: Maximum number of generations or function evaluations reached.</span></span>
<span><span class="co">#&gt; Optimization using 'AHR-ES' algorithm.</span></span>
<span><span class="co">#&gt; Function value: 0.04122286 </span></span>
<span><span class="co">#&gt; Status: Maximum number of generations or function evaluations reached. </span></span>
<span><span class="co">#&gt; Parameters:</span></span>
<span><span class="co">#&gt; [1]  0.028236432  0.005735164 -0.012675352 -0.037462605 -0.019210042</span></span>
<span><span class="co">#&gt; Computation: (1000 generations)</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;     8000        0</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="parameters-as-lists">Parameters as lists<a class="anchor" aria-label="anchor" href="#parameters-as-lists"></a>
</h3>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/calibrate.html">calibrate</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>par1<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span>, par2<span class="op">=</span><span class="cn">NA</span>, par3<span class="op">=</span><span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="va">sphereN</span>,</span>
<span>          lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>, upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">100</span>, <span class="fl">5</span><span class="op">)</span>,</span>
<span>          phases<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span>,<span class="op">-</span><span class="fl">3</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>, replicates<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">5</span><span class="op">)</span>, control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit<span class="op">=</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Parameter estimation in two phases.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 1: 2 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'AHR-ES'.</span></span>
<span><span class="co">#&gt;  Phase 1 finished (1.12s)</span></span>
<span><span class="co">#&gt;  Function value: 13.1182</span></span>
<span><span class="co">#&gt;  Parameter values: 0.0558 0.181</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; - Phase 2: 4 out of 5 parameters are currently active.</span></span>
<span><span class="co">#&gt;  Using optimization method 'AHR-ES'.</span></span>
<span><span class="co">#&gt;  Phase 2 finished (2.14s)</span></span>
<span><span class="co">#&gt;  Function value: 8.96767</span></span>
<span><span class="co">#&gt;  Parameter values: -0.0167 0.164 -0.14 0.0335</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Status: Maximum number of generations or function evaluations reached.</span></span>
<span><span class="co">#&gt; Optimization using 'AHR-ES' algorithm.</span></span>
<span><span class="co">#&gt; Function value: 8.96767 </span></span>
<span><span class="co">#&gt; Status: Maximum number of generations or function evaluations reached. </span></span>
<span><span class="co">#&gt; Parameters:</span></span>
<span><span class="co">#&gt;       par11       par12       par13        par2        par3 </span></span>
<span><span class="co">#&gt; -0.01674863  0.16445070  3.00000000 -0.13951818  0.03351795 </span></span>
<span><span class="co">#&gt; * Some parameters are not calibrated.</span></span>
<span><span class="co">#&gt; Computation: (1000 generations)</span></span>
<span><span class="co">#&gt; function gradient </span></span>
<span><span class="co">#&gt;     8000        0</span></span></code></pre></div>
<p>Note that the function <code>fn</code> must be able to take a list as
parameter set, and the user must ensure this works beforehand.</p>
</div>
<div class="section level3">
<h3 id="running-in-parallel-1">Running in parallel<a class="anchor" aria-label="anchor" href="#running-in-parallel-1"></a>
</h3>
<p>Most algorithms implemented in the <code>calibrate</code> function
can benefit of parallel computation. For the methods that uses the
numerical computation of the gradient, this will be calculated in
parallel as in <code><a href="../reference/optim2.html">optim2()</a></code>. In order to support any type of
parallel implementation, the parallel setup is NOT automatic, and must
be done by the user previous to executed the optimization, as described
in the following example:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span></span>
<span><span class="va">ncores</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/detectCores.html" class="external-link">detectCores</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span> <span class="co"># number of cores to be used</span></span>
<span><span class="va">cl</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">makeCluster</a></span><span class="op">(</span><span class="va">ncores</span><span class="op">)</span></span>
<span><span class="co"># this is slower than sequential for very fast models (like this one)</span></span>
<span><span class="va">calib</span> <span class="op">=</span> <span class="fu"><a href="../reference/calibrate.html">calibrate</a></span><span class="op">(</span>par<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">5</span><span class="op">)</span>, fn<span class="op">=</span><span class="va">sphereN</span>,</span>
<span>                  replicates<span class="op">=</span><span class="fl">3</span>, </span>
<span>                  lower<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, </span>
<span>                  upper<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">+</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span>, </span>
<span>                  phases<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span>,<span class="fl">3</span><span class="op">)</span>, </span>
<span>                  control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>parallel<span class="op">=</span><span class="cn">TRUE</span>, ncores<span class="op">=</span><span class="va">ncores</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html" class="external-link">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span> <span class="co"># close the parallel connections</span></span></code></pre></div>
<p>While parallelising an optimization can speed up computations, it is
not always faster than running the optimisation sequentially. Parallel
execution introduces additional overhead, such as data communication,
thread or process management, and synchronization, which can outweigh
the benefits when the objective function is relatively fast to evaluate.
As a result, for computationally inexpensive functions, the time
required to coordinate parallel execution may lead to slower performance
compared to a sequential approach. However, as the evaluation time of
the objective function increases, the efficiency gains from
parallelisation become more significant, making it a valuable strategy
for complex or computationally demanding optimization problems.</p>
<p>Please, refer to <code>vignette(package="calibrar")</code> for
additional vignettes or to the <a href="https://roliveros-ramos.github.io/calibrar/">calibrar website</a>
for more details.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ricardo Oliveros-Ramos.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
